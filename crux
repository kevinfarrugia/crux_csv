#!/bin/bash

usage() {
  echo -e "Usage: $0 [options...] <origin> <key> \n\
 -h, --help          Display help
 -o, --output <path> Output path where to save results \n\
 -a, --append        Append results to output file \n\
 -f, --full          Include histogram data (grouped as Good, NI and Poor) \n\
 -V, --verbose       Make the operation more talkative" 1>&2
  exit 1
}

output=""
verbose=0
append=0
full=0
query=""

# $@ is all command line parameters passed to the script.
# -o is for short options like -v
# -l is for long options with double dash like --version
# the comma separates different long options
options=$(getopt -l "help,verbose,output:,append,full" -o "hVafo:" -- "$@")

# set --:
# If no arguments follow this option, then the positional parameters are unset. Otherwise, the positional parameters
# are set to the arguments, even if some of them begin with a ‘-’.
eval set -- "$options"

while true; do
  case $1 in
  -h | --help)
    usage
    ;;
  -V | --verbose)
    verbose=1
    ;;
  -a | --append)
    append=1
    ;;
  -f | --full)
    full=1
    ;;
  -o | --output)
    output=$2
    ;;
  --)
    shift
    break
    ;;
  esac
  shift
done

origin=$1
key=$2

if [ -z "$key" ]; then
  echo "CrUX API key is missing or invalid."
  exit 1
fi

if [ -z "$origin" ]; then
  usage
fi

if [ "$verbose" == 1 ]; then
  echo -e "Running CrUX on $origin"
  echo -e "...\n"
fi

if [ "$append" == 0 ] && [ -f "$output" ]; then
  read -p "Output file exists. Overwrite? (y/N) " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Nn]$ ]] || [[ -z $REPLY ]]; then
    exit
  fi
fi

if [ ! -z "$output" ]; then
  if [ $append == 0 ]; then
    if [ "$verbose" == 1 ]; then
      echo "Overwriting contents in $output"
      echo
    fi
    if [ "$full" == 1 ]; then
      echo "Date,Origin,Form,LCP,LCP (good),LCP (NI),LCP (poor),CLS,CLS (good),CLS (NI),CLS (poor),FCP,FCP (good),FCP (NI),FCP (poor),FID,FID (good),FID (NI),FID (poor),TTFB,TTFB (good),TTFB (NI),TTFB (poor),INP,INP (good),INP (NI),INP (poor)" >$output
    else
      echo "Date,Origin,Form,LCP,CLS,FCP,FID,TTFB,INP" >$output
    fi
  fi
fi

if [ "$verbose" == 1 ]; then
  echo -e "curl https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=$key\n\
  --header 'Content-Type: application/json'\n\
  --data \"{'origin': '$origin', 'formFactor': 'PHONE'}\""
  echo
fi

if [ "$full" == 1 ]; then
  query='[(now | strftime("%Y/%m/%d")), .record.key.origin, .record.key.formFactor, .record.metrics.largest_contentful_paint.percentiles.p75, .record.metrics.largest_contentful_paint.histogram[0].density, .record.metrics.largest_contentful_paint.histogram[1].density, .record.metrics.largest_contentful_paint.histogram[2].density, .record.metrics.cumulative_layout_shift.percentiles.p75, .record.metrics.cumulative_layout_shift.histogram[0].density, .record.metrics.cumulative_layout_shift.histogram[1].density, .record.metrics.cumulative_layout_shift.histogram[2].density, .record.metrics.first_contentful_paint.percentiles.p75, .record.metrics.first_contentful_paint.histogram[0].density, .record.metrics.first_contentful_paint.histogram[1].density, .record.metrics.first_contentful_paint.histogram[2].density, .record.metrics.first_input_delay.percentiles.p75, .record.metrics.first_input_delay.histogram[0].density, .record.metrics.first_input_delay.histogram[1].density, .record.metrics.first_input_delay.histogram[2].density, .record.metrics.experimental_time_to_first_byte.percentiles.p75, .record.metrics.experimental_time_to_first_byte.histogram[0].density, .record.metrics.experimental_time_to_first_byte.histogram[1].density, .record.metrics.experimental_time_to_first_byte.histogram[2].density, .record.metrics.experimental_interaction_to_next_paint.percentiles.p75, .record.metrics.experimental_interaction_to_next_paint.histogram[0].density, .record.metrics.experimental_interaction_to_next_paint.histogram[1].density, .record.metrics.experimental_interaction_to_next_paint.histogram[2].density]'
else
  query='[(now | strftime("%Y/%m/%d")), .record.key.origin, .record.key.formFactor, .record.metrics.largest_contentful_paint.percentiles.p75, .record.metrics.cumulative_layout_shift.percentiles.p75, .record.metrics.first_contentful_paint.percentiles.p75, .record.metrics.first_input_delay.percentiles.p75, .record.metrics.experimental_time_to_first_byte.percentiles.p75, .record.metrics.experimental_interaction_to_next_paint.percentiles.p75]'
fi

curl -s https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=$key \
  --header 'Content-Type: application/json' \
  --data "{'origin': '$origin', 'formFactor': 'PHONE'}" |
  jq -r "$query |
  @csv" |
  if [ ! -z "$output" ]; then
    tee 1>>$output 2>&1
  else
    cat
  fi

if [ "$verbose" == 1 ]; then
  echo -e "curl https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=$key\n\
  --header 'Content-Type: application/json'\n\
  --data {'origin': '$origin', 'formFactor': 'DESKTOP'}"
  echo
fi

curl -s https://chromeuxreport.googleapis.com/v1/records:queryRecord?key=$key \
  --header 'Content-Type: application/json' \
  --data "{'origin': '$origin', 'formFactor': 'DESKTOP'}" |
  jq -r "$query |
  @csv" |
  if [ ! -z "$output" ]; then
    tee 1>>$output 2>&1
  else
    cat
  fi

if [ ! -z "$output" ] && [ "$verbose" == 1 ]; then
  echo -e "Saved results to $output\n"
fi

if [ "$verbose" == 1 ]; then
  echo "Done."
fi
